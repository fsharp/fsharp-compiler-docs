<!DOCTYPE html>
<html lang="en" data-root="https://fsharp.github.io/fsharp-compiler-docs/">
<head>
    <meta charset="UTF-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="F# Software Foundation; Microsoft; F# Contributors" name="author">
    <!-- Opengraph properties (https://ogp.me/) -->
    <meta property="og:site_name" content="F# Compiler Guide">
    <meta property="og:title" content="Reusing typechecking results" />
    <meta property="og:url" content="https://fsharp.github.io/fsharp-compiler-docs/reusing-typechecking-results.html">
    <meta property="og:type" content="website" />
    <!-- Twitter cards (https://developer.twitter.com/en/docs/twitter-for-websites/cards/overview/summary-card-with-large-image) -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="https://fsharp.github.io/fsharp-compiler-docs/">
    <meta name="twitter:title" content="Reusing typechecking results">
    
    <title>Reusing typechecking results | F# Compiler Guide</title>
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" rel="stylesheet">
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <link href="https://fsharp.github.io/fsharp-compiler-docs/img/favicon.ico" rel="icon" sizes="32x32" type="image/png"/>
    <script type="application/javascript" src="https://fsharp.github.io/fsharp-compiler-docs/content/fsdocs-theme-set-dark.js"></script>
    <script type="application/javascript" src="https://fsharp.github.io/fsharp-compiler-docs/content/fsdocs-details-set-expanded.js"></script>
    <link href="https://fsharp.github.io/fsharp-compiler-docs/content/fsdocs-default.css" rel="stylesheet" type="text/css"/>
    <link href="https://fsharp.github.io/fsharp-compiler-docs/content/fsdocs-theme.css" rel="stylesheet" type="text/css"/>
    
    
</head>
<body class="content">
<header>
    <div class="start">
        <div id="menu-toggle">
            <iconify-icon class="icon closed" height="22" icon="eva:menu-fill" width="22"></iconify-icon>
            <iconify-icon class="icon open" height="22" icon="mi:close" width="22"></iconify-icon>
            <input type="checkbox" name="mobile-menu" />
            <ul class="menu">
                <li class="nav-header">Links</li>
                <li class="license-menu-item builtin-menu-item nav-item"><a class="nav-link" href="https://github.com/dotnet/fsharp/blob/main/License.txt">License</a>
                </li>
                <li class="release-notes-menu-item builtin-menu-item nav-item"><a class="nav-link"
                                        href="https://github.com/dotnet/fsharp/blob/main/release-notes.md">Release
                    Notes</a></li>
                <li class="repository-menu-item builtin-menu-item nav-item"><a class="nav-link" href="https://github.com/dotnet/fsharp/">Source
                    Repository</a></li>
                <li class="nav-header active">
  Compiler Internals
</li>             
<li class="nav-item active">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/reusing-typechecking-results.html">
    Reusing typechecking results
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/overview.html">
    Overview
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/coding-standards.html">
    Coding standards
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/diagnostics.html">
    Diagnostics
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/representations.html">
    Representations
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/debug-emit.html">
    Debug emit
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/names.html">
    Display names, logical names and compiled names
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fsi-emit.html">
    F# Interactive Emit
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/optimizations.html">
    Optimizations
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/large-inputs-and-stack-overflows.html">
    Large inputs
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/memory-usage.html">
    Memory usage
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/compiler-startup-performance.html">
    Startup Performance
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/changing-the-ast.html">
    Changing the AST
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/running-documentation-locally.html">
    Running the documentation locally
  </a>
</li>             
<li class="nav-header ">
  Language Service Internals
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/tooling-features.html">
    Overview
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/project-builds.html">
    Project builds
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/caches.html">
    FSharpChecker caches
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/react.html">
    Incrementality
  </a>
</li>             
<li class="nav-header ">
  FSharp.Compiler.Service
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/tokenizer.html">
    Tutorial: Tokenizing
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/untypedtree.html">
    Tutorial: Expressions
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/untypedtree-apis.html">
    Tutorial: AST APIs
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/symbols.html">
    Tutorial: Symbols
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/editor.html">
    Tutorial: Editor services
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/typedtree.html">
    Tutorial: Expressions
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/project.html">
    Tutorial: Project analysis
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/interactive.html">
    Tutorial: Hosted execution
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/compiler.html">
    Tutorial: Hosting the compiler
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/corelib.html">
    Notes on FSharp.Core
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/filesystem.html">
    IFileSystem
  </a>
</li>             
<li class="nav-header ">
  FSharp.Core
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fsharp-core-notes.html">
    Guidance
  </a>
</li>             
<li class="nav-header ">
  Release Notes
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/release-notes/About.html">
    About
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/release-notes/Language.html">
    F# Language
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/release-notes/FSharp.Core.html">
    FSharp.Core
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/release-notes/FSharp.Compiler.Service.html">
    FSharp.Compiler.Service
  </a>
</li>             
<li class="nav-header ">
  Other
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/perf-discussions-archive.html">
    Comparisons

  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/optimizations-equality.html">
    Compiling Equality

  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/regression-testing-pipeline.html">
    F# Compiler Regression Testing

  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/lsp.html">
    F# LSP

  </a>
</li>
                <li class="nav-header">
  API Reference
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/reference/index.html">
    All Namespaces
  </a>
</li>
            </ul>
        </div>
        <a href="https://fsharp.github.io/fsharp-compiler-docs/">
            <img alt="Header menu logo" src="https://fsharp.github.io/fsharp-compiler-docs/img/logo.png">
            <strong>F# Compiler Guide</strong>
        </a>
    </div>
    <div class="end">
        <a href="https://github.com/dotnet/fsharp/" target="_blank">
            <iconify-icon icon="uil:github" width="26" height="26"></iconify-icon>
        </a>
        <iconify-icon id="search-btn" icon="carbon:search" class="search" width="24" height="24"></iconify-icon>
        <fsdocs-theme-toggle></fsdocs-theme-toggle>
    </div>
</header>
<aside id="fsdocs-main-menu">
    <ul class="menu">
        <li class="nav-header">Links</li>
        <li class="license-menu-item builtin-menu-item nav-item"><a class="nav-link" href="https://github.com/dotnet/fsharp/blob/main/License.txt">License</a>
        </li>
        <li class="release-notes-menu-item builtin-menu-item nav-item"><a class="nav-link"
                                href="https://github.com/dotnet/fsharp/blob/main/release-notes.md">Release
            Notes</a></li>
        <li class="repository-menu-item builtin-menu-item nav-item"><a class="nav-link" href="https://github.com/dotnet/fsharp/">Source
            Repository</a></li>
        <li class="nav-header active">
  Compiler Internals
</li>             
<li class="nav-item active">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/reusing-typechecking-results.html">
    Reusing typechecking results
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/overview.html">
    Overview
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/coding-standards.html">
    Coding standards
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/diagnostics.html">
    Diagnostics
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/representations.html">
    Representations
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/debug-emit.html">
    Debug emit
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/names.html">
    Display names, logical names and compiled names
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fsi-emit.html">
    F# Interactive Emit
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/optimizations.html">
    Optimizations
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/large-inputs-and-stack-overflows.html">
    Large inputs
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/memory-usage.html">
    Memory usage
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/compiler-startup-performance.html">
    Startup Performance
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/changing-the-ast.html">
    Changing the AST
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/running-documentation-locally.html">
    Running the documentation locally
  </a>
</li>             
<li class="nav-header ">
  Language Service Internals
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/tooling-features.html">
    Overview
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/project-builds.html">
    Project builds
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/caches.html">
    FSharpChecker caches
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/react.html">
    Incrementality
  </a>
</li>             
<li class="nav-header ">
  FSharp.Compiler.Service
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/tokenizer.html">
    Tutorial: Tokenizing
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/untypedtree.html">
    Tutorial: Expressions
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/untypedtree-apis.html">
    Tutorial: AST APIs
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/symbols.html">
    Tutorial: Symbols
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/editor.html">
    Tutorial: Editor services
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/typedtree.html">
    Tutorial: Expressions
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/project.html">
    Tutorial: Project analysis
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/interactive.html">
    Tutorial: Hosted execution
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/compiler.html">
    Tutorial: Hosting the compiler
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/corelib.html">
    Notes on FSharp.Core
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fcs/filesystem.html">
    IFileSystem
  </a>
</li>             
<li class="nav-header ">
  FSharp.Core
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/fsharp-core-notes.html">
    Guidance
  </a>
</li>             
<li class="nav-header ">
  Release Notes
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/release-notes/About.html">
    About
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/release-notes/Language.html">
    F# Language
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/release-notes/FSharp.Core.html">
    FSharp.Core
  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/release-notes/FSharp.Compiler.Service.html">
    FSharp.Compiler.Service
  </a>
</li>             
<li class="nav-header ">
  Other
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/perf-discussions-archive.html">
    Comparisons

  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/optimizations-equality.html">
    Compiling Equality

  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/regression-testing-pipeline.html">
    F# Compiler Regression Testing

  </a>
</li>             
<li class="nav-item ">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/lsp.html">
    F# LSP

  </a>
</li>
        <li class="nav-header">
  API Reference
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://fsharp.github.io/fsharp-compiler-docs/reference/index.html">
    All Namespaces
  </a>
</li>
    </ul>
</aside>
<main>
    <div id="content">
        
<h1><a name="Reusing-typechecking-results-between-compiler-runs" class="anchor" href="#Reusing-typechecking-results-between-compiler-runs">Reusing typechecking results between compiler runs</a></h1>
<p>Caching and reusing compilation results between compiler runs will be an optimization technique aimed at improving the performance and efficiency of the F# development experience.</p>
<h2><a name="Motivation" class="anchor" href="#Motivation">Motivation</a></h2>
<ul>
<li><p><strong>Performance</strong>. Things like recomputing type information for large projects are time-consuming. By caching the results, subsequent compilation can skip some steps, leading to faster builds.</p></li>
<li><p><strong>Better IDE cold start</strong>. IDEs can provide faster IntelliSense, code navigation, and other features if they can quickly access cached compilation information. The bigger and the less coupled the project is, the greater will be the gains.</p></li>
</ul>
<h3><a name="Example-real-world-scenarios" class="anchor" href="#Example-real-world-scenarios">Example real-world scenarios</a></h3>
<p>The optimization will benefit the most in large and not very interdependent projects. For instance, a 100-files test project where a single test is changed. MSBuild will mark the project for recompilation but thanks to the improvement only one file would be recompiled in the full-blown manner.</p>
<h2><a name="Premises" class="anchor" href="#Premises">Premises</a></h2>
<p>Here are some assumptions I am coming with after tinkering with the topic and investigating the current state of the art.</p>
<h3><a name="Premise-1-current-compiler-design" class="anchor" href="#Premise-1-current-compiler-design">Premise 1: current compiler design</a></h3>
<p>The heart of the compiler, <a href="../src/Compiler/Driver/fsc.fs">fsc.fs</a>, is split into 6 phases (<code>main1</code> - <code>main6</code>). The code is designed to pass minimum information between phases, using the <code>Args</code> structure, which is essentially a data bag. The first phase takes info from the program arguments.</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="id">main1</span> <span class="pn">(</span><span class="o">..</span><span class="pn">.</span><span class="id">args</span><span class="o">..</span><span class="pn">.</span><span class="pn">)</span>
<span class="o">|&gt;</span> <span class="id">main2</span>
<span class="o">|&gt;</span> <span class="id">main3</span>
<span class="o">|&gt;</span> <span class="id">main4</span> <span class="pn">(</span><span class="id">tcImportsCapture</span><span class="pn">,</span> <span class="id">dynamicAssemblyCreator</span><span class="pn">)</span>
<span class="o">|&gt;</span> <span class="id">main5</span>
<span class="o">|&gt;</span> <span class="id">main6</span> <span class="id">dynamicAssemblyCreator</span>
</code></pre>
<h3><a name="Premise-2-current-compilation-time-consumption" class="anchor" href="#Premise-2-current-compilation-time-consumption">Premise 2: current compilation time consumption</a></h3>
<p>Let's measure (<code>fsc --times</code>) the fresh compilation of large F# files. We'll use examples from our benchmarks - those are different but should be good to see general trends.</p>
<p><strong>SomethingToCompile.fs</strong></p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="o">--------------------------------------------------------------------------------------------------------</span>
<span class="pn">|</span><span class="id">Phase</span> <span class="id">name</span>                          <span class="pn">|</span><span class="id">Elapsed</span> <span class="pn">|</span><span class="id">Duration</span><span class="pn">|</span> <span class="id">WS</span><span class="pn">(</span><span class="id">MB</span><span class="pn">)</span><span class="pn">|</span>  <span class="id">GC0</span>  <span class="pn">|</span>  <span class="id">GC1</span>  <span class="pn">|</span>  <span class="id">GC2</span>  <span class="pn">|</span><span class="id">Handles</span><span class="pn">|</span><span class="id">Threads</span><span class="pn">|</span>
<span class="o">|------------------------------------|--------|--------|-------|-------|-------|-------|-------|-------|</span>
<span class="c">// main1</span>
<span class="pn">|</span><span class="id">Import</span> <span class="id">mscorlib</span><span class="o">+</span><span onmouseout="hideTip(event, 'fs1', 1)" onmouseover="showTip(event, 'fs1', 1)" class="id">FSharp</span><span class="pn">.</span><span onmouseout="hideTip(event, 'fs2', 2)" onmouseover="showTip(event, 'fs2', 2)" class="id">Core</span>         <span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">2720</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">2604</span><span class="pn">|</span>     <span class="n">96</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">365</span><span class="pn">|</span>     <span class="n">30</span><span class="pn">|</span>     <span class="o">&lt;--</span> <span class="id">long</span>
<span class="pn">|</span><span class="id">Parse</span> <span class="id">inputs</span>                        <span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">3378</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">0560</span><span class="pn">|</span>    <span class="n">108</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">372</span><span class="pn">|</span>     <span class="n">30</span><span class="pn">|</span>
<span class="pn">|</span><span class="id">Import</span> <span class="id">non</span><span class="o">-</span><span class="id">system</span> <span class="id">references</span>        <span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">3932</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">0476</span><span class="pn">|</span>    <span class="n">127</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">372</span><span class="pn">|</span>     <span class="n">30</span><span class="pn">|</span>
<span class="pn">|</span><span class="id">Typecheck</span>                           <span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">9020</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">5025</span><span class="pn">|</span>    <span class="n">164</span><span class="pn">|</span>      <span class="n">3</span><span class="pn">|</span>      <span class="n">2</span><span class="pn">|</span>      <span class="n">1</span><span class="pn">|</span>    <span class="n">456</span><span class="pn">|</span>     <span class="n">46</span><span class="pn">|</span>     <span class="o">&lt;--</span> <span class="id">longest</span>
<span class="pn">|</span><span class="id">Typechecked</span>                         <span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">9087</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">0002</span><span class="pn">|</span>    <span class="n">164</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">456</span><span class="pn">|</span>     <span class="n">46</span><span class="pn">|</span>
<span class="c">// main2</span>
<span class="pn">|</span><span class="id">Write</span> <span onmouseout="hideTip(event, 'fs3', 3)" onmouseover="showTip(event, 'fs3', 3)" class="id">Interface</span> <span class="id">File</span>                <span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">9191</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">0000</span><span class="pn">|</span>    <span class="n">164</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">456</span><span class="pn">|</span>     <span class="n">46</span><span class="pn">|</span>
<span class="pn">|</span><span class="id">Write</span> <span class="id">XML</span> <span class="id">doc</span> <span class="id">signatures</span>            <span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">9280</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">0000</span><span class="pn">|</span>    <span class="n">164</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">456</span><span class="pn">|</span>     <span class="n">46</span><span class="pn">|</span>
<span class="pn">|</span><span class="id">Write</span> <span class="id">XML</span> <span class="id">docs</span>                      <span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">9342</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">0002</span><span class="pn">|</span>    <span class="n">164</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">456</span><span class="pn">|</span>     <span class="n">46</span><span class="pn">|</span>
<span class="c">// main3</span>
<span class="pn">|</span><span class="id">Encode</span> <span onmouseout="hideTip(event, 'fs3', 4)" onmouseover="showTip(event, 'fs3', 4)" class="id">Interface</span> <span onmouseout="hideTip(event, 'fs4', 5)" onmouseover="showTip(event, 'fs4', 5)" class="id">Data</span>               <span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">9778</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">0345</span><span class="pn">|</span>    <span class="n">164</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">456</span><span class="pn">|</span>     <span class="n">46</span><span class="pn">|</span>
<span class="pn">|</span><span class="id">Optimizations</span>                       <span class="pn">|</span>  <span class="n">1</span><span class="pn">,</span><span class="n">2312</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">2463</span><span class="pn">|</span>    <span class="n">178</span><span class="pn">|</span>      <span class="n">2</span><span class="pn">|</span>      <span class="n">2</span><span class="pn">|</span>      <span class="n">1</span><span class="pn">|</span>    <span class="n">456</span><span class="pn">|</span>     <span class="n">46</span><span class="pn">|</span>     <span class="o">&lt;--</span> <span class="id">long</span>
<span class="pn">|</span><span class="id">Ending</span> <span class="id">Optimizations</span>                <span class="pn">|</span>  <span class="n">1</span><span class="pn">,</span><span class="n">2386</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">0000</span><span class="pn">|</span>    <span class="n">178</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">456</span><span class="pn">|</span>     <span class="n">46</span><span class="pn">|</span>
<span class="pn">|</span><span class="id">Encoding</span> <span class="id">OptData</span>                    <span class="pn">|</span>  <span class="n">1</span><span class="pn">,</span><span class="n">2549</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">0093</span><span class="pn">|</span>    <span class="n">178</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">456</span><span class="pn">|</span>     <span class="n">46</span><span class="pn">|</span>
<span class="pn">|</span><span onmouseout="hideTip(event, 'fs5', 6)" onmouseover="showTip(event, 'fs5', 6)" class="id">TailCall</span> <span class="id">Checks</span>                     <span class="pn">|</span>  <span class="n">1</span><span class="pn">,</span><span class="n">2687</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">0054</span><span class="pn">|</span>    <span class="n">178</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">456</span><span class="pn">|</span>     <span class="n">46</span><span class="pn">|</span>
<span class="c">// main4, main5</span>
<span class="pn">|</span><span class="id">TAST</span> <span class="k">-&gt;</span> <span class="id">IL</span>                          <span class="pn">|</span>  <span class="n">1</span><span class="pn">,</span><span class="n">3657</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">0883</span><span class="pn">|</span>    <span class="n">180</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">456</span><span class="pn">|</span>     <span class="n">46</span><span class="pn">|</span>
<span class="c">// main6</span>
<span class="pn">|</span><span class="id">Write</span> <span class="pn">.</span><span class="id">NET</span> <span class="id">Binary</span>                   <span class="pn">|</span>  <span class="n">1</span><span class="pn">,</span><span class="n">6016</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">2284</span><span class="pn">|</span>    <span class="n">183</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">462</span><span class="pn">|</span>     <span class="n">46</span><span class="pn">|</span>     <span class="o">&lt;--</span> <span class="id">long</span>
<span class="o">--------------------------------------------------------------------------------------------------------</span>
</code></pre>
<p><strong>decentlySizedStandAloneFile.fs</strong></p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="o">--------------------------------------------------------------------------------------------------------</span>
<span class="pn">|</span><span class="id">Phase</span> <span class="id">name</span>                          <span class="pn">|</span><span class="id">Elapsed</span> <span class="pn">|</span><span class="id">Duration</span><span class="pn">|</span> <span class="id">WS</span><span class="pn">(</span><span class="id">MB</span><span class="pn">)</span><span class="pn">|</span>  <span class="id">GC0</span>  <span class="pn">|</span>  <span class="id">GC1</span>  <span class="pn">|</span>  <span class="id">GC2</span>  <span class="pn">|</span><span class="id">Handles</span><span class="pn">|</span><span class="id">Threads</span><span class="pn">|</span>
<span class="o">|------------------------------------|--------|--------|-------|-------|-------|-------|-------|-------|</span>
<span class="c">// main1</span>
<span class="pn">|</span><span class="id">Import</span> <span class="id">mscorlib</span><span class="o">+</span><span onmouseout="hideTip(event, 'fs1', 7)" onmouseover="showTip(event, 'fs1', 7)" class="id">FSharp</span><span class="pn">.</span><span onmouseout="hideTip(event, 'fs2', 8)" onmouseover="showTip(event, 'fs2', 8)" class="id">Core</span>         <span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">3285</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">3120</span><span class="pn">|</span>    <span class="n">101</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">365</span><span class="pn">|</span>     <span class="n">30</span><span class="pn">|</span>     <span class="o">&lt;--</span> <span class="id">longest</span>
<span class="pn">|</span><span class="id">Parse</span> <span class="id">inputs</span>                        <span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">3673</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">0292</span><span class="pn">|</span>    <span class="n">108</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">374</span><span class="pn">|</span>     <span class="n">30</span><span class="pn">|</span>
<span class="pn">|</span><span class="id">Import</span> <span class="id">non</span><span class="o">-</span><span class="id">system</span> <span class="id">references</span>        <span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">4354</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">0622</span><span class="pn">|</span>    <span class="n">128</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">374</span><span class="pn">|</span>     <span class="n">30</span><span class="pn">|</span>
<span class="pn">|</span><span class="id">Typecheck</span>                           <span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">6464</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">2045</span><span class="pn">|</span>    <span class="n">144</span><span class="pn">|</span>      <span class="n">1</span><span class="pn">|</span>      <span class="n">1</span><span class="pn">|</span>      <span class="n">1</span><span class="pn">|</span>    <span class="n">378</span><span class="pn">|</span>     <span class="n">30</span><span class="pn">|</span>     <span class="o">&lt;--</span> <span class="id">long</span>
<span class="pn">|</span><span class="id">Typechecked</span>                         <span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">6522</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">0004</span><span class="pn">|</span>    <span class="n">144</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">378</span><span class="pn">|</span>     <span class="n">30</span><span class="pn">|</span>
<span class="c">// main2</span>
<span class="pn">|</span><span class="id">Write</span> <span onmouseout="hideTip(event, 'fs3', 9)" onmouseover="showTip(event, 'fs3', 9)" class="id">Interface</span> <span class="id">File</span>                <span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">6597</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">0000</span><span class="pn">|</span>    <span class="n">144</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">378</span><span class="pn">|</span>     <span class="n">30</span><span class="pn">|</span>
<span class="pn">|</span><span class="id">Write</span> <span class="id">XML</span> <span class="id">doc</span> <span class="id">signatures</span>            <span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">6661</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">0000</span><span class="pn">|</span>    <span class="n">144</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">378</span><span class="pn">|</span>     <span class="n">30</span><span class="pn">|</span>
<span class="pn">|</span><span class="id">Write</span> <span class="id">XML</span> <span class="id">docs</span>                      <span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">6710</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">0002</span><span class="pn">|</span>    <span class="n">144</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">378</span><span class="pn">|</span>     <span class="n">30</span><span class="pn">|</span>
<span class="c">// main3</span>
<span class="pn">|</span><span class="id">Encode</span> <span onmouseout="hideTip(event, 'fs3', 10)" onmouseover="showTip(event, 'fs3', 10)" class="id">Interface</span> <span onmouseout="hideTip(event, 'fs4', 11)" onmouseover="showTip(event, 'fs4', 11)" class="id">Data</span>               <span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">7273</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">0503</span><span class="pn">|</span>    <span class="n">154</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">378</span><span class="pn">|</span>     <span class="n">30</span><span class="pn">|</span>
<span class="pn">|</span><span class="id">Optimizations</span>                       <span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">8757</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">1425</span><span class="pn">|</span>    <span class="n">172</span><span class="pn">|</span>      <span class="n">1</span><span class="pn">|</span>      <span class="n">1</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">378</span><span class="pn">|</span>     <span class="n">30</span><span class="pn">|</span>     <span class="o">&lt;--</span> <span class="id">long</span>
<span class="pn">|</span><span class="id">Ending</span> <span class="id">Optimizations</span>                <span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">8815</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">0000</span><span class="pn">|</span>    <span class="n">172</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">378</span><span class="pn">|</span>     <span class="n">30</span><span class="pn">|</span>
<span class="pn">|</span><span class="id">Encoding</span> <span class="id">OptData</span>                    <span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">8899</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">0024</span><span class="pn">|</span>    <span class="n">173</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">378</span><span class="pn">|</span>     <span class="n">30</span><span class="pn">|</span>
<span class="pn">|</span><span onmouseout="hideTip(event, 'fs5', 12)" onmouseover="showTip(event, 'fs5', 12)" class="id">TailCall</span> <span class="id">Checks</span>                     <span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">8990</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">0025</span><span class="pn">|</span>    <span class="n">173</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">378</span><span class="pn">|</span>     <span class="n">30</span><span class="pn">|</span>
<span class="c">// main4, main5</span>
<span class="pn">|</span><span class="id">TAST</span> <span class="k">-&gt;</span> <span class="id">IL</span>                          <span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">9487</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">0447</span><span class="pn">|</span>    <span class="n">176</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">378</span><span class="pn">|</span>     <span class="n">30</span><span class="pn">|</span>
<span class="c">// main6</span>
<span class="pn">|</span><span class="id">Write</span> <span class="pn">.</span><span class="id">NET</span> <span class="id">Binary</span>                   <span class="pn">|</span>  <span class="n">1</span><span class="pn">,</span><span class="n">1530</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">1972</span><span class="pn">|</span>    <span class="n">180</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">384</span><span class="pn">|</span>     <span class="n">30</span><span class="pn">|</span>     <span class="o">&lt;--</span> <span class="id">long</span>
<span class="o">--------------------------------------------------------------------------------------------------------</span>
</code></pre>
<p><strong>CE100xnest5.fs</strong></p>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="o">--------------------------------------------------------------------------------------------------------</span>
<span class="pn">|</span><span class="id">Phase</span> <span class="id">name</span>                          <span class="pn">|</span><span class="id">Elapsed</span> <span class="pn">|</span><span class="id">Duration</span><span class="pn">|</span> <span class="id">WS</span><span class="pn">(</span><span class="id">MB</span><span class="pn">)</span><span class="pn">|</span>  <span class="id">GC0</span>  <span class="pn">|</span>  <span class="id">GC1</span>  <span class="pn">|</span>  <span class="id">GC2</span>  <span class="pn">|</span><span class="id">Handles</span><span class="pn">|</span><span class="id">Threads</span><span class="pn">|</span>
<span class="o">|------------------------------------|--------|--------|-------|-------|-------|-------|-------|-------|</span>
<span class="c">// main1</span>
<span class="pn">|</span><span class="id">Import</span> <span class="id">mscorlib</span><span class="o">+</span><span onmouseout="hideTip(event, 'fs1', 13)" onmouseover="showTip(event, 'fs1', 13)" class="id">FSharp</span><span class="pn">.</span><span onmouseout="hideTip(event, 'fs2', 14)" onmouseover="showTip(event, 'fs2', 14)" class="id">Core</span>         <span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">4092</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">4084</span><span class="pn">|</span>    <span class="n">101</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">365</span><span class="pn">|</span>     <span class="n">30</span><span class="pn">|</span>     <span class="o">&lt;--</span> <span class="id">long</span>
<span class="pn">|</span><span class="id">Parse</span> <span class="id">inputs</span>                        <span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">4635</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">0445</span><span class="pn">|</span>    <span class="n">108</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">374</span><span class="pn">|</span>     <span class="n">30</span><span class="pn">|</span>
<span class="pn">|</span><span class="id">Import</span> <span class="id">non</span><span class="o">-</span><span class="id">system</span> <span class="id">references</span>        <span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">5475</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">0775</span><span class="pn">|</span>    <span class="n">128</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">374</span><span class="pn">|</span>     <span class="n">30</span><span class="pn">|</span>
<span class="pn">|</span><span class="id">Typecheck</span>                           <span class="pn">|</span>  <span class="n">3</span><span class="pn">,</span><span class="n">1157</span><span class="pn">|</span>  <span class="n">2</span><span class="pn">,</span><span class="n">5612</span><span class="pn">|</span>    <span class="n">198</span><span class="pn">|</span>     <span class="n">18</span><span class="pn">|</span>     <span class="n">15</span><span class="pn">|</span>      <span class="n">3</span><span class="pn">|</span>    <span class="n">712</span><span class="pn">|</span>     <span class="n">45</span><span class="pn">|</span>     <span class="o">&lt;--</span> <span class="id">long</span>
<span class="pn">|</span><span class="id">Typechecked</span>                         <span class="pn">|</span>  <span class="n">3</span><span class="pn">,</span><span class="n">1219</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">0002</span><span class="pn">|</span>    <span class="n">198</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">712</span><span class="pn">|</span>     <span class="n">45</span><span class="pn">|</span>
<span class="c">// main2</span>
<span class="pn">|</span><span class="id">Write</span> <span onmouseout="hideTip(event, 'fs3', 15)" onmouseover="showTip(event, 'fs3', 15)" class="id">Interface</span> <span class="id">File</span>                <span class="pn">|</span>  <span class="n">3</span><span class="pn">,</span><span class="n">1280</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">0000</span><span class="pn">|</span>    <span class="n">198</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">712</span><span class="pn">|</span>     <span class="n">45</span><span class="pn">|</span>
<span class="pn">|</span><span class="id">Write</span> <span class="id">XML</span> <span class="id">doc</span> <span class="id">signatures</span>            <span class="pn">|</span>  <span class="n">3</span><span class="pn">,</span><span class="n">1363</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">0000</span><span class="pn">|</span>    <span class="n">198</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">712</span><span class="pn">|</span>     <span class="n">45</span><span class="pn">|</span>
<span class="pn">|</span><span class="id">Write</span> <span class="id">XML</span> <span class="id">docs</span>                      <span class="pn">|</span>  <span class="n">3</span><span class="pn">,</span><span class="n">1435</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">0002</span><span class="pn">|</span>    <span class="n">198</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">712</span><span class="pn">|</span>     <span class="n">45</span><span class="pn">|</span>
<span class="c">// main3</span>
<span class="pn">|</span><span class="id">Encode</span> <span onmouseout="hideTip(event, 'fs3', 16)" onmouseover="showTip(event, 'fs3', 16)" class="id">Interface</span> <span onmouseout="hideTip(event, 'fs4', 17)" onmouseover="showTip(event, 'fs4', 17)" class="id">Data</span>               <span class="pn">|</span>  <span class="n">3</span><span class="pn">,</span><span class="n">1803</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">0296</span><span class="pn">|</span>    <span class="n">198</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">712</span><span class="pn">|</span>     <span class="n">45</span><span class="pn">|</span>
<span class="pn">|</span><span class="id">Optimizations</span>                       <span class="pn">|</span>  <span class="n">8</span><span class="pn">,</span><span class="n">9949</span><span class="pn">|</span>  <span class="n">5</span><span class="pn">,</span><span class="n">8049</span><span class="pn">|</span>    <span class="n">216</span><span class="pn">|</span>     <span class="n">43</span><span class="pn">|</span>     <span class="n">42</span><span class="pn">|</span>      <span class="n">2</span><span class="pn">|</span>    <span class="n">457</span><span class="pn">|</span>     <span class="n">45</span><span class="pn">|</span>     <span class="o">&lt;--</span> <span class="id">longest</span>
<span class="pn">|</span><span class="id">Ending</span> <span class="id">Optimizations</span>                <span class="pn">|</span>  <span class="n">9</span><span class="pn">,</span><span class="n">0015</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">0000</span><span class="pn">|</span>    <span class="n">216</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">457</span><span class="pn">|</span>     <span class="n">45</span><span class="pn">|</span>
<span class="pn">|</span><span class="id">Encoding</span> <span class="id">OptData</span>                    <span class="pn">|</span>  <span class="n">9</span><span class="pn">,</span><span class="n">0090</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">0010</span><span class="pn">|</span>    <span class="n">216</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">457</span><span class="pn">|</span>     <span class="n">45</span><span class="pn">|</span>
<span class="pn">|</span><span onmouseout="hideTip(event, 'fs5', 18)" onmouseover="showTip(event, 'fs5', 18)" class="id">TailCall</span> <span class="id">Checks</span>                     <span class="pn">|</span>  <span class="n">9</span><span class="pn">,</span><span class="n">0190</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">0013</span><span class="pn">|</span>    <span class="n">216</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">457</span><span class="pn">|</span>     <span class="n">45</span><span class="pn">|</span>
<span class="c">// main4, main5</span>
<span class="pn">|</span><span class="id">TAST</span> <span class="k">-&gt;</span> <span class="id">IL</span>                          <span class="pn">|</span>  <span class="n">9</span><span class="pn">,</span><span class="n">0463</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">0210</span><span class="pn">|</span>    <span class="n">217</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">458</span><span class="pn">|</span>     <span class="n">46</span><span class="pn">|</span>
<span class="c">// main6</span>
<span class="pn">|</span><span class="id">Write</span> <span class="pn">.</span><span class="id">NET</span> <span class="id">Binary</span>                   <span class="pn">|</span>  <span class="n">9</span><span class="pn">,</span><span class="n">2463</span><span class="pn">|</span>  <span class="n">0</span><span class="pn">,</span><span class="n">1930</span><span class="pn">|</span>    <span class="n">218</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>      <span class="n">0</span><span class="pn">|</span>    <span class="n">464</span><span class="pn">|</span>     <span class="n">46</span><span class="pn">|</span>     <span class="o">&lt;--</span> <span class="id">long</span>
<span class="o">--------------------------------------------------------------------------------------------------------</span>
</code></pre>
<p>The phases taking the longest are marked in the right. Those are assembly import, type check, optimizations and IL writing.</p>
<p>Optimizations are not relevant in the dev loop with run/debug/test cycles so we won't take those into account.</p>
<h2><a name="Experiment-force-generated-signature-files-efficiency" class="anchor" href="#Experiment-force-generated-signature-files-efficiency">Experiment: force-generated signature files efficiency</a></h2>
<p>In the initial discussions, we decided to make an experiment to see if force-generating and caching signature files in a project saves much time during recompilations.</p>
<p>My setup was a project of 25 independent big files (copies of <code>Utilities.fs</code>).
There, I measured (few times, with cleaning artifacts, using <code>--times</code>):
1. Typechecking - <strong>time1</strong>
2. Typechecking + all signature generation (<code>--allsigs</code>) - <strong>time2</strong>
3. Typechecking with signatures generated (left from previous run and added to the project) - <strong>time3</strong>
4. Typechecking with partial signature usage and generation (20 sigs used, 5 generated) - <strong>time4</strong></p>
<p>I picked a slow machine to better see the differences. But <em>all the differences</em> were largely <strong>marginal</strong> (including between <strong>time1</strong> and <strong>time3</strong>). I can imagine squeezing stable single-digit % performance differences in a cleaner experiment - that said:
- It's not clear if it's going to be for better or for worse, since the signature generation penalty can be bigger than the benefit of having them.
- Even if it's for better, such a small improvement won't be worse the hassle.</p>
<p>Therefore, I think it's not the way to go here.</p>
<details>
<summary>Numbers, for completeness</summary>
<pre class="fssnip highlighted"><code lang="fsharp"><span class="id">Normal</span> <span class="id">compilation</span><span class="pn">:</span>
<span class="n">1.</span> <span class="id">Typecheck</span><span class="pn">:</span> <span class="n">23.7531</span>
<span class="n">2.</span> <span class="id">Typecheck</span><span class="pn">:</span> <span class="n">27.4234</span>
<span class="n">3.</span> <span class="id">Typecheck</span><span class="pn">:</span> <span class="n">24.5202</span>

<span class="id">Normal</span> <span class="id">compilation</span> <span class="o">+</span> <span class="id">generating</span> <span class="id">signatures</span> <span class="pn">(</span><span class="id">added</span> <span class="id">extra</span> <span class="id">`</span><span class="id">ReportTime</span><span class="id">`</span> <span class="k">for</span> <span class="id">measuring</span> <span class="id">the</span> <span class="id">latter</span><span class="pn">)</span><span class="pn">:</span>
<span class="n">1.</span> <span class="id">Typecheck</span><span class="pn">:</span> <span class="n">26.5991</span><span class="pn">,</span> <span class="id">Siggen</span><span class="pn">:</span> <span class="n">1.9369</span>
<span class="n">2.</span> <span class="id">Typecheck</span><span class="pn">:</span> <span class="n">25.0246</span><span class="pn">,</span> <span class="id">Siggen</span><span class="pn">:</span> <span class="n">1.7517</span>
<span class="n">3.</span> <span class="id">Typecheck</span><span class="pn">:</span> <span class="n">27.0057</span><span class="pn">,</span> <span class="id">Siggen</span><span class="pn">:</span> <span class="n">1.9093</span>

<span class="id">Compilation</span> <span class="k">with</span> <span class="id">given</span> <span class="id">signatures</span><span class="pn">:</span>
<span class="n">1.</span> <span class="id">Typecheck</span><span class="pn">:</span> <span class="n">25.7741</span>
<span class="n">2.</span> <span class="id">Typecheck</span><span class="pn">:</span> <span class="n">26.2904</span>
<span class="n">3.</span> <span class="id">Typecheck</span><span class="pn">:</span> <span class="n">24.3852</span>

<span class="id">Compilation</span> <span class="k">with</span> <span class="id">given</span> <span class="n">80</span><span class="o">%</span> <span class="id">signatures</span> <span class="o">+</span> <span class="id">generating</span> <span class="n">20</span><span class="o">%</span> <span class="id">signatures</span><span class="pn">:</span>
<span class="n">1.</span> <span class="id">Typecheck</span><span class="pn">:</span> <span class="n">24.1338</span><span class="pn">,</span> <span class="id">Siggen</span><span class="pn">:</span> <span class="n">0.5284</span>
<span class="n">2.</span> <span class="id">Typecheck</span><span class="pn">:</span> <span class="n">27.6037</span><span class="pn">,</span> <span class="id">Siggen</span><span class="pn">:</span> <span class="n">0.7526</span>
<span class="n">3.</span> <span class="id">Typecheck</span><span class="pn">:</span> <span class="n">25.6967</span><span class="pn">,</span> <span class="id">Siggen</span><span class="pn">:</span> <span class="n">0.6244</span>
</code></pre>
</details>
<h2><a name="Implementation-plan" class="anchor" href="#Implementation-plan">Implementation plan</a></h2>
<p>The conclusion from the above is that there is a lot of potential in caching - at the same time, implementing things to the full potential right away will require serious changes in the compiler code, which will be dangerous, hard to test and review. Therefore, I propose to implement the feature in stages where each stage brings gains in some scenarios.</p>
<p><strong>Stage 1 - force-gen and compare typechecking graphs</strong></p>
<p>We already create the TC graph in <code>main1</code> and we are able to dump it (in Mermaid) via the compiler flags.</p>
<p>That means we can force-gen and save the graph which will allow us to skip retypechecking if we detect that the graph is not changed. We should also track all the compilation information (the argument string) and the last update times of the files.</p>
<p>This step won't bring big observable benefits, yet it will create necessary MSBuild hooks to communicate the intermediate files folder towards the compiler, add time-based and hash-based cache invalidation logic, and create testing rails which will include the <code>clean</code> and <code>rebuild</code> tests to make sure the cache is easily invalidated on demand.</p>
<p><strong>Stage 2 - skip retypechecking for some files</strong></p>
<p>In <code>main1</code>, we do unpickling (= deserializing) and pickling (= serializing) of the code. This currently happens on the module/namespace basis.</p>
<p>In this stage, we will fully implement pickling and unpickling of all typechecked files (<code>CheckedImplFile</code> per file as well as all other outputs of <code>main1</code> which cannot be cheaply recreated like <code>topAttrs</code> and <code>CcuThunk</code>). Parts of the pickling/unpickling can reuse the primitives already existing in <code>TypedTreePickle</code> and built upon them. So we can save acquired typechecking information to the intermediate folder after the typechecking - and for the files not needing retypechecking as per graph diff, skip the phase, instead restoring the typechecking info. We also need to identify the side effects happening during typechecking and probably replay them in such cases.</p>
<p>This is likely the biggest amount of work expected but it will hugely benefit the scenarios when only the edge of the graph is affected (think one test in a test project).</p>
<p><strong>Stage 3 - reduce signature data generation</strong></p>
<p>In <code>main3</code>, we encode signature data in the assemblies.</p>
<p>Since we are addressing run/debug/test scenarios, a lot of projects can avoid signature data at all, because signature data is only needed for cross-project compilation. This could be detected automatically for certain types of projects (think web apps, console apps, test projects).</p>
<p>For libraries, the signature information resource blob (a byte array) would have to be split into per-file data and we'll and logic to recombine the splits with freshly typechecked information into a single binary resource back.</p>
<p><strong>Stage 4 - reuse import data</strong></p>
<p>In <code>main1</code>, we restore imported assemblies to get their IL (e.g. system assemblies).</p>
<p>So here, we can serialize and cache imported IL - we'll need to evaluate and benchmark if per assembly or per assembly block (cases like  System.*.dll). We'll apply this for the cross-project case, to not reimport IL for repeating assemblies but instead restore it from the cache - by adding a cross-project intermediate file location to be coordinated with MSBuild properties.</p>
<p>This will be a smaller gain for any particular project but a big accumulated one for large multi-project solutions.</p>
<h2><a name="Testing-and-benchmarking" class="anchor" href="#Testing-and-benchmarking">Testing and benchmarking</a></h2>
<p>We should have a compiler switch for this: applying it to current typechecking tests shouldn't make any difference in results. Tests should test that restored cached results + reusing them should be equivalent to fresh typechecking results.</p>
<p>Benchmarks should be added or run at every stage to the <code>FCSBenchmarks</code> project. A good inspiration can be workflow-style tests for updating files done by @0101 in Transparent Compiler.</p>

        <div class="fsdocs-tip" id="fs1">Multiple items<br />namespace Microsoft.FSharp<br /><br />--------------------<br />namespace FSharp</div>
<div class="fsdocs-tip" id="fs2">namespace Microsoft.FSharp.Core</div>
<div class="fsdocs-tip" id="fs3">Multiple items<br />type InterfaceAttribute =
  inherit Attribute
  new: unit -&gt; InterfaceAttribute<br /><br />--------------------<br />new: unit -&gt; InterfaceAttribute</div>
<div class="fsdocs-tip" id="fs4">namespace Microsoft.FSharp.Data</div>
<div class="fsdocs-tip" id="fs5">Multiple items<br />type TailCallAttribute =
  inherit Attribute
  new: unit -&gt; TailCallAttribute<br /><br />--------------------<br />new: unit -&gt; TailCallAttribute</div>

    </div>
</main>
<aside id="fsdocs-page-menu">
    <p id="on-this-page">On this page</p>
    <ul>
  <li class="level-1">
    <a href="#Reusing-typechecking-results-between-compiler-runs">
      Reusing typechecking results between compiler runs
    </a>
  </li>
  <li class="level-2">
    <a href="#Motivation">
      Motivation
    </a>
  </li>
  <li class="level-3">
    <a href="#Example-real-world-scenarios">
      Example real-world scenarios
    </a>
  </li>
  <li class="level-2">
    <a href="#Premises">
      Premises
    </a>
  </li>
  <li class="level-3">
    <a href="#Premise-1-current-compiler-design">
      Premise 1: current compiler design
    </a>
  </li>
  <li class="level-3">
    <a href="#Premise-2-current-compilation-time-consumption">
      Premise 2: current compilation time consumption
    </a>
  </li>
  <li class="level-2">
    <a href="#Experiment-force-generated-signature-files-efficiency">
      Experiment: force-generated signature files efficiency
    </a>
  </li>
  <li class="level-2">
    <a href="#Implementation-plan">
      Implementation plan
    </a>
  </li>
  <li class="level-2">
    <a href="#Testing-and-benchmarking">
      Testing and benchmarking
    </a>
  </li>
</ul>
</aside>
<dialog>
    <input type="search" placeholder="Search docs" />
    <div class="results">
        <ul></ul>
        <p class="empty">Type something to start searching.</p>
    </div>
</dialog>
<script type="module" src="https://fsharp.github.io/fsharp-compiler-docs/content/fsdocs-tips.js"></script>
<script type="module" src="https://fsharp.github.io/fsharp-compiler-docs/content/fsdocs-theme-toggle.js"></script>
<script type="module" src="https://fsharp.github.io/fsharp-compiler-docs/content/fsdocs-details-toggle.js"></script>
<script type="module" src="https://fsharp.github.io/fsharp-compiler-docs/content/fsdocs-theme.js"></script>
<script type="module" src="https://fsharp.github.io/fsharp-compiler-docs/content/fsdocs-search.js"></script>

</body>
</html>